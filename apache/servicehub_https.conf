<VirtualHost *:80>
	ServerName servicehub-dev.humanbrainproject.org
	#
	# redirect http to https
	#
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
</VirtualHost>

#
# auto manage SSL cert with let's encrypt
#
ManagedDomain servicehub-dev.humanbrainproject.org

<VirtualHost *:443>
    ServerName servicehub-dev.humanbrainproject.org
    DocumentRoot /var/www/html
    Protocols h2 http/1.1
    SSLEngine on

    OIDCProviderMetadataURL "https://services-dev.humanbrainproject.eu/oidc/.well-known/openid-configuration"
    OIDCClientID "servicehub"
    OIDCClientSecret "AMMv39aAqGMWps1IJ06BvssJMocdaTbQik-sAq_svCks4zOe9URPruOIPY_2LL-qYz2fmZOT78O0DOZzCnJjkGs"
    OIDCRedirectURI "https://servicehub-dev.humanbrainproject.org/redirect_uri"
    OIDCCryptoPassphrase "xxxxxxxxxxxxxxxxxxxxxxxx"
    OIDCAuthNHeader "userid"

    <Location "/">
        AuthType openid-connect
        Require valid-user
    </Location>

	RewriteEngine On
    ProxyAddHeaders On
    ProxyPreserveHost On
    #
    # fake pseudo URL for OIDC, do not proxy
    #
    ProxyPass /redirect_uri !
    
    # if websocket prowy to ws://
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://proxy/$1 [P,L]
    # if not websocket proxy to http://
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://proxy/$1 [P,L]
 	ProxyPassReverse / http://proxy/

</VirtualHost>
